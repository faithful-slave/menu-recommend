# Project: ìŒì‹ì¶”ì²œê¸° (êµ­ê°€/ì¢…ë¥˜/ë§µê¸° í•„í„°) + ì‹¤ì‹œê°„ ë°©ë¬¸ìˆ˜ + ëœë¤ + ì¢‹ì•„ìš”(ì•„ì´í”¼ë‹¹ 1íšŒ)
# Stack: Cloudflare Pages (ì •ì ) + Pages Functions (ì„œë²„ë¦¬ìŠ¤ API) + Cloudflare D1 (SQLite)
# í´ë” êµ¬ì¡°
# .
# â”œâ”€â”€ index.html                # ë‹¨ì¼ í˜ì´ì§€ UI (TailwindCDN)
# â”œâ”€â”€ schema.sql                # D1 í…Œì´ë¸”/ì¸ë±ìŠ¤ ìŠ¤í‚¤ë§ˆ
# â”œâ”€â”€ functions/
# â”‚   â””â”€â”€ api/
# â”‚       â”œâ”€â”€ visit.js         # ì˜¤ëŠ˜ ë°©ë¬¸ ê¸°ë¡ (IPë‹¹ 1íšŒ) + í•©ê³„ ë°˜í™˜
# â”‚       â”œâ”€â”€ visit-count.js   # ì˜¤ëŠ˜ ë°©ë¬¸ìˆ˜ ì¡°íšŒ
# â”‚       â”œâ”€â”€ like.js          # item ì¢‹ì•„ìš” (IPë‹¹ 1íšŒ)
# â”‚       â””â”€â”€ like-count.js    # item ì¢‹ì•„ìš” í•©ê³„ ì¡°íšŒ
# â”œâ”€â”€ wrangler.toml             # D1 ë°”ì¸ë”© ì„¤ì • ì˜ˆì‹œ
# â””â”€â”€ README.md                 # ë°°í¬/ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ


############################
# index.html
############################
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ìŒì‹ì¶”ì²œê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">ğŸœ ìŒì‹ì¶”ì²œê¸°</h1>
      <div class="text-sm sm:text-base">ì˜¤ëŠ˜ ë°©ë¬¸ìˆ˜: <span id="visitCount" class="font-semibold">-</span></div>
    </header>

    <section class="mt-6 bg-white rounded-2xl shadow-sm border border-slate-200 p-4 sm:p-6">
      <div class="grid sm:grid-cols-4 gap-4">
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">ë‚˜ë¼</label>
          <select id="country" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-400">
            <option value="">ì „ì²´</option>
            <option>í•œêµ­</option>
            <option>ì¼ë³¸</option>
            <option>ì¤‘êµ­</option>
            <option>íƒœêµ­</option>
            <option>ì¸ë„</option>
            <option>ì´íƒˆë¦¬ì•„</option>
            <option>ë©•ì‹œì½”</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">ì¢…ë¥˜</label>
          <select id="category" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-400">
            <option value="">ì „ì²´</option>
            <option>ë©´</option>
            <option>ë°¥</option>
            <option>ì°Œê°œ/íƒ•</option>
            <option>êµ¬ì´/ë³¶ìŒ</option>
            <option>ë””ì €íŠ¸</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-600 mb-1">ë§µê¸°</label>
          <select id="spicy" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-400">
            <option value="">ì „ì²´</option>
            <option value="0">0 â€” ì•ˆë§¤ì›€</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 â€” ì•„ì£¼ë§¤ì›€</option>
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button id="btnRecommend" class="flex-1 rounded-xl bg-slate-900 text-white py-2.5 font-semibold shadow hover:opacity-90">ì¶”ì²œí•˜ê¸°</button>
          <button id="btnRandom" class="rounded-xl bg-slate-200 text-slate-900 py-2.5 px-3 font-semibold hover:bg-slate-300">ëœë¤</button>
        </div>
      </div>
    </section>

    <section id="result" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 flex items-center gap-5">
        <div class="flex-1">
          <div class="text-xs uppercase tracking-wider text-slate-500">ì¶”ì²œë©”ë‰´</div>
          <h2 id="itemName" class="mt-1 text-xl sm:text-2xl font-bold"></h2>
          <p id="itemMeta" class="mt-1 text-slate-600"></p>
          <div class="mt-3 flex items-center gap-3">
            <button id="btnLike" class="rounded-xl bg-rose-600 text-white px-4 py-2 font-semibold hover:opacity-90">ì¢‹ì•„ìš”</button>
            <span class="text-sm">ì¢‹ì•„ìš” <span id="likeCount" class="font-semibold">0</span></span>
          </div>
        </div>
        <div class="shrink-0">
          <div id="spicyBadge" class="rounded-xl px-3 py-2 text-sm font-semibold bg-orange-100 text-orange-700">ë§µê¸° -</div>
        </div>
      </div>
    </section>

    <footer class="mt-10 text-center text-xs text-slate-500">Â© ìŒì‹ì¶”ì²œê¸° â€” Cloudflare Pages + D1 Demo</footer>
  </div>

  <script type="module">
    // --- ìƒ˜í”Œ ë°ì´í„°ì…‹ (idëŠ” ì„œë²„ ì¢‹ì•„ìš” í‚¤ë¡œ ì‚¬ìš©) ---
    const FOODS = [
      { id:"kimchi-jjigae",  name:"ê¹€ì¹˜ì°Œê°œ",    country:"í•œêµ­", category:"ì°Œê°œ/íƒ•",  spicy:3 },
      { id:"bibimbap",       name:"ë¹„ë¹”ë°¥",      country:"í•œêµ­", category:"ë°¥",      spicy:1 },
      { id:"ramen",          name:"ë¼ë©˜",        country:"ì¼ë³¸", category:"ë©´",      spicy:1 },
      { id:"mapo-tofu",      name:"ë§ˆíŒŒë‘ë¶€",    country:"ì¤‘êµ­", category:"êµ¬ì´/ë³¶ìŒ", spicy:3 },
      { id:"pad-thai",       name:"íŒŸíƒ€ì´",      country:"íƒœêµ­", category:"ë©´",      spicy:2 },
      { id:"green-curry",    name:"ê·¸ë¦°ì»¤ë¦¬",    country:"íƒœêµ­", category:"ì°Œê°œ/íƒ•",  spicy:4 },
      { id:"butter-chicken", name:"ë²„í„°ì¹˜í‚¨",    country:"ì¸ë„", category:"êµ¬ì´/ë³¶ìŒ", spicy:2 },
      { id:"tiramisu",       name:"í‹°ë¼ë¯¸ìˆ˜",    country:"ì´íƒˆë¦¬ì•„", category:"ë””ì €íŠ¸", spicy:0 },
      { id:"taco",           name:"íƒ€ì½”",        country:"ë©•ì‹œì½”", category:"ë°¥",      spicy:2 },
      { id:"jajangmyeon",    name:"ì§œì¥ë©´",      country:"ì¤‘êµ­", category:"ë©´",      spicy:0 },
    ];

    // --- ì˜¤ëŠ˜ ë°©ë¬¸ ê¸°ë¡ (IPë‹¹ 1íšŒ) & ì¹´ìš´íŠ¸ í‘œì‹œ ---
    async function touchVisitAndLoadCount(){
      try {
        await fetch('/api/visit', { method:'POST' });
      } catch(e) { console.warn('visit post failed', e); }
      const r = await fetch('/api/visit-count');
      const j = await r.json();
      document.getElementById('visitCount').textContent = j.count ?? '-';
    }

    // --- í•„í„° ê¸°ë°˜ ì¶”ì²œ ---
    function filterFoods(){
      const country = document.getElementById('country').value;
      const category = document.getElementById('category').value;
      const spicy = document.getElementById('spicy').value;
      return FOODS.filter(f =>
        (country === '' || f.country === country) &&
        (category === '' || f.category === category) &&
        (spicy === '' || f.spicy === Number(spicy))
      );
    }

    function pickRandom(arr){
      if (!arr.length) return null;
      return arr[Math.floor(Math.random()*arr.length)];
    }

    // --- UI ë Œë” ---
    let currentItem = null;
    async function renderItem(item){
      if (!item) { document.getElementById('result').classList.add('hidden'); return; }
      currentItem = item;
      document.getElementById('itemName').textContent = item.name;
      document.getElementById('itemMeta').textContent = `${item.country} Â· ${item.category}`;
      document.getElementById('spicyBadge').textContent = `ë§µê¸° ${item.spicy}`;
      document.getElementById('result').classList.remove('hidden');
      // ì¢‹ì•„ìš” ì¹´ìš´íŠ¸ ë¡œë“œ
      const r = await fetch(`/api/like-count?item_id=${encodeURIComponent(item.id)}`);
      const j = await r.json();
      document.getElementById('likeCount').textContent = j.count ?? 0;
    }

    // --- ì´ë²¤íŠ¸ ---
    document.getElementById('btnRecommend').addEventListener('click', () => {
      const list = filterFoods();
      renderItem(pickRandom(list));
    });
    document.getElementById('btnRandom').addEventListener('click', () => {
      renderItem(pickRandom(FOODS));
    });
    document.getElementById('btnLike').addEventListener('click', async () => {
      if (!currentItem) return;
      const r = await fetch('/api/like', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ item_id: currentItem.id })});
      const j = await r.json();
      document.getElementById('likeCount').textContent = j.count ?? 0;
    });

    // ì´ˆê¸°í™”
    touchVisitAndLoadCount();
  </script>
</body>
</html>


############################
# functions/api/visit.js
############################
export async function onRequest({ env, request }) {
  const db = env.DB;
  const ip = getIP(request);
  const date = getLocalDateYYYYMMDD();
  await ensureSchema(db);
  // ì˜¤ëŠ˜ ë‚ ì§œ + IP ê³ ìœ  ë°©ë¬¸ ì €ì¥ (ì¤‘ë³µ ë¬´ì‹œ)
  await db.prepare(
    `INSERT OR IGNORE INTO visits(date, ip, ts) VALUES (?, ?, strftime('%s','now'))`
  ).bind(date, ip).run();
  // í•©ê³„ ë°˜í™˜
  const { results } = await db.prepare(
    `SELECT COUNT(1) as cnt FROM visits WHERE date = ?`
  ).bind(date).all();
  return json({ ok: true, count: results?.[0]?.cnt ?? 0 });
}

function getIP(request) {
  const h = request.headers;
  return h.get('cf-connecting-ip') || (h.get('x-forwarded-for')||'').split(',')[0].trim() || '0.0.0.0';
}

function getLocalDateYYYYMMDD() {
  const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' });
  const [y,m,d] = fmt.formatToParts(new Date()).filter(p=>p.type!=='literal').map(p=>p.value);
  return `${y}-${m}-${d}`;
}

async function ensureSchema(db){
  // ê°€ë²¼ìš´ ì²´í¬ (ì—†ìœ¼ë©´ ìƒì„±)
  await db.exec(`CREATE TABLE IF NOT EXISTS visits (
    date TEXT NOT NULL,
    ip   TEXT NOT NULL,
    ts   INTEGER,
    UNIQUE(date, ip)
  );`);
}

function json(obj, init={}){ return new Response(JSON.stringify(obj), {status:200, headers:{'content-type':'application/json', ...init.headers}}); }


############################
# functions/api/visit-count.js
############################
export async function onRequest({ env }) {
  const db = env.DB;
  await ensureSchema(db);
  const date = getLocalDateYYYYMMDD();
  const { results } = await db.prepare(`SELECT COUNT(1) as cnt FROM visits WHERE date = ?`).bind(date).all();
  return new Response(JSON.stringify({ count: results?.[0]?.cnt ?? 0 }), { headers:{'content-type':'application/json'} });
}

function getLocalDateYYYYMMDD() {
  const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' });
  const [y,m,d] = fmt.formatToParts(new Date()).filter(p=>p.type!=='literal').map(p=>p.value);
  return `${y}-${m}-${d}`;
}

async function ensureSchema(db){
  await db.exec(`CREATE TABLE IF NOT EXISTS visits (
    date TEXT NOT NULL,
    ip   TEXT NOT NULL,
    ts   INTEGER,
    UNIQUE(date, ip)
  );`);
}


############################
# functions/api/like.js
############################
export async function onRequest({ env, request }) {
  const db = env.DB;
  const ip = getIP(request);
  const body = await request.json().catch(()=>({}));
  const item = String(body.item_id||'').slice(0,100);
  if (!item) return new Response(JSON.stringify({ ok:false, error:'item_id required' }), { status:400, headers:{'content-type':'application/json'} });
  await ensureSchema(db);
  // IPë‹¹ 1íšŒ ì¢‹ì•„ìš” (ì¤‘ë³µ ë¬´ì‹œ)
  await db.prepare(`INSERT OR IGNORE INTO likes(item_id, ip, ts) VALUES (?, ?, strftime('%s','now'))`).bind(item, ip).run();
  // í•©ê³„ ê³„ì‚°
  const { results } = await db.prepare(`SELECT COUNT(1) as cnt FROM likes WHERE item_id = ?`).bind(item).all();
  return new Response(JSON.stringify({ ok:true, count: results?.[0]?.cnt ?? 0 }), { headers:{'content-type':'application/json'} });
}

function getIP(request){
  const h = request.headers;
  return h.get('cf-connecting-ip') || (h.get('x-forwarded-for')||'').split(',')[0].trim() || '0.0.0.0';
}

async function ensureSchema(db){
  await db.exec(`CREATE TABLE IF NOT EXISTS likes (
    item_id TEXT NOT NULL,
    ip      TEXT NOT NULL,
    ts      INTEGER,
    UNIQUE(item_id, ip)
  );`);
}


############################
# functions/api/like-count.js
############################
export async function onRequest({ env, request }) {
  const db = env.DB;
  const url = new URL(request.url);
  const item = String(url.searchParams.get('item_id')||'').slice(0,100);
  if (!item) return new Response(JSON.stringify({ count: 0 }), { headers:{'content-type':'application/json'} });
  await ensureSchema(db);
  const { results } = await db.prepare(`SELECT COUNT(1) as cnt FROM likes WHERE item_id = ?`).bind(item).all();
  return new Response(JSON.stringify({ count: results?.[0]?.cnt ?? 0 }), { headers:{'content-type':'application/json'} });
}

async function ensureSchema(db){
  await db.exec(`CREATE TABLE IF NOT EXISTS likes (
    item_id TEXT NOT NULL,
    ip      TEXT NOT NULL,
    ts      INTEGER,
    UNIQUE(item_id, ip)
  );`);
}


############################
# schema.sql  (ë°°í¬ ì „ í•œ ë²ˆë§Œ ì‹¤í–‰)
############################
-- ë°©ë¬¸ í…Œì´ë¸” (ì˜¤ëŠ˜ ë‚ ì§œ + IP ê¸°ì¤€ìœ¼ë¡œ 1íšŒ)
CREATE TABLE IF NOT EXISTS visits (
  date TEXT NOT NULL,
  ip   TEXT NOT NULL,
  ts   INTEGER,
  UNIQUE(date, ip)
);

-- ì¢‹ì•„ìš” í…Œì´ë¸” (ì•„ì´í…œ + IP ê¸°ì¤€ìœ¼ë¡œ 1íšŒ)
CREATE TABLE IF NOT EXISTS likes (
  item_id TEXT NOT NULL,
  ip      TEXT NOT NULL,
  ts      INTEGER,
  UNIQUE(item_id, ip)
);


############################
# wrangler.toml (ì˜ˆì‹œ)
############################
name = "food-recommender"
compatibility_date = "2024-11-01"

[[d1_databases]]
binding = "DB"         # ì½”ë“œì—ì„œ env.DB ë¡œ ì ‘ê·¼
database_name = "fooddb"
database_id = "REPLACE_WITH_YOUR_D1_ID"


############################
# README.md (ìš”ì•½ ê°€ì´ë“œ)
############################
# 1) Cloudflare ê³„ì • ìƒì„± â†’ Pages ìƒˆ í”„ë¡œì íŠ¸ â†’ ì´ ë¦¬í¬ ì—°ê²°(ë˜ëŠ” ì—…ë¡œë“œ)
# 2) D1 ìƒì„±: ëŒ€ì‹œë³´ë“œì—ì„œ D1 DB ìƒì„± í›„ wrangler.toml ì˜ database_id êµì²´
# 3) ë¡œì»¬ì—ì„œ ìŠ¤í‚¤ë§ˆ ì ìš© (ì„ íƒ) ë˜ëŠ” ëŒ€ì‹œë³´ë“œ ì¿¼ë¦¬ë¡œ schema.sql ì‹¤í–‰
#    wrangler d1 execute fooddb --file=./schema.sql
# 4) Pages â†’ Settings â†’ Functionsì—ì„œ D1 ë°”ì¸ë”©(DB)ì„ ì¶”ê°€ (binding ì´ë¦„ DB)
# 5) ë°°í¬ í›„ ì ‘ì†í•˜ë©´ /api/visit ê°€ ìë™ìœ¼ë¡œ IP 1íšŒ ê¸°ë¡, /api/visit-count ë¡œ ì˜¤ëŠ˜ ë°©ë¬¸ìˆ˜ í‘œì‹œ
# 6) ì¶”ì²œ/ëœë¤ìœ¼ë¡œ ì•„ì´í…œ ë…¸ì¶œ â†’ ì¢‹ì•„ìš” ëˆ„ë¥´ë©´ /api/like ê°€ IPë‹¹ 1íšŒ ì§‘ê³„
# 7) í•„ìš” ì‹œ FOODS ë°°ì—´ì— ë©”ë‰´ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜, ë³„ë„ D1 í…Œì´ë¸”ë¡œ í™•ì¥ ê°€ëŠ¥
